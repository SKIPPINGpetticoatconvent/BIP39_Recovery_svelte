name: Build and Release (Windows + macOS + Linux/Tails)

permissions:
  contents: write

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ==========================================================
  # Linux ÊûÑÂª∫‰ªªÂä°ÔºàTails Á¶ªÁ∫øÂÖºÂÆπ + ÈùôÊÄÅÂ∞ÅË£Ö WebKitGTKÔºâ
  # ==========================================================
  build-linux:
    name: ÊûÑÂª∫ Linux (Tails Á¶ªÁ∫øÂÖºÂÆπ)
    runs-on: ubuntu-22.04
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ÁºìÂ≠ò Go Ê®°Âùó
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: ËÆæÁΩÆ Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ÂÆâË£ÖÁ≥ªÁªü‰æùËµñÔºàÂê´ WebKitGTKÔºâ
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            build-essential \
            pkg-config \
            file \
            appimagetool \
            desktop-file-utils \
            gir1.2-webkit2-4.0

      - name: Ê∑ªÂä† GOPATH/bin Âà∞ PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ÂÆâË£Ö Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ÊûÑÂª∫ÂâçÁ´Ø
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: ÊûÑÂª∫ Wails ÂèØÊâßË°åÊñá‰ª∂
        run: |
          wails build -clean -platform linux/amd64
          mkdir -p AppDir/usr/bin
          cp build/bin/BIP39Recovery AppDir/usr/bin/
          chmod +x AppDir/usr/bin/BIP39Recovery

      - name: ÂàõÂª∫ Desktop Êñá‰ª∂‰∏éÂõæÊ†á
        run: |
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cat > AppDir/usr/share/applications/BIP39Recovery.desktop <<'EOF'
          [Desktop Entry]
          Name=BIP39 Recovery Tool
          Exec=BIP39Recovery
          Icon=BIP39Recovery
          Type=Application
          Categories=Utility;Security;Finance;
          Comment=BIP39 Mnemonic Recovery Tool (Tails Compatible)
          Terminal=false
          StartupNotify=true
          X-AppImage-Version=1.0
          EOF
          desktop-file-validate AppDir/usr/share/applications/BIP39Recovery.desktop || true

          if [ -f "build/appicon.png" ]; then
            cp build/appicon.png AppDir/usr/share/icons/hicolor/256x256/apps/BIP39Recovery.png
          else
            touch AppDir/usr/share/icons/hicolor/256x256/apps/BIP39Recovery.png
          fi

      - name: ‰ΩøÁî® linuxdeploy ÊâìÂåÖ GTK ‰æùËµñ
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage --appimage-extract
          ./squashfs-root/AppRun \
            --appdir AppDir \
            --plugin gtk \
            --executable AppDir/usr/bin/BIP39Recovery \
            --desktop-file AppDir/usr/share/applications/BIP39Recovery.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/BIP39Recovery.png

      - name: ÈùôÊÄÅÂ∞ÅË£Ö WebKitGTK Âä®ÊÄÅÂ∫ì‰∏éÂ≠êËøõÁ®ãÔºà‰øÆÊ≠£ÁâàÔºâ
        run: |
          mkdir -p AppDir/usr/libexec/webkit2gtk-4.0
          if [ -d /usr/libexec/webkit2gtk-4.0 ]; then
            cp -a /usr/libexec/webkit2gtk-4.0/* AppDir/usr/libexec/webkit2gtk-4.0/
            chmod +x AppDir/usr/libexec/webkit2gtk-4.0/* || true
          fi

          mkdir -p AppDir/usr/lib/x86_64-linux-gnu
          for lib in libwebkit2gtk-4.0 libjavascriptcoregtk-4.0 libgtk-3 libgobject-2.0 libglib-2.0 libpango-1.0 libcairo; do
            cp -a /usr/lib/x86_64-linux-gnu/${lib}.so* AppDir/usr/lib/x86_64-linux-gnu/ 2>/dev/null || true
          done

          find AppDir -type f -executable -exec strip --strip-unneeded {} + 2>/dev/null || true

      - name: ÂàõÂª∫ AppRunÔºà‰øÆÊ≠£ÁâàÔºöÁ¶ÅÁî® gvfs + ÊîØÊåÅ WebKit Â≠êËøõÁ®ãÔºâ
        run: |
          cat > AppDir/AppRun <<'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}

          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/x86_64-linux-gnu:${HERE}/usr/lib:${LD_LIBRARY_PATH}"

          export GIO_USE_VFS=local
          export GIO_MODULE_DIR="${HERE}/usr/lib/x86_64-linux-gnu/gio/modules"

          export XDG_DATA_DIRS="${HERE}/usr/share:$XDG_DATA_DIRS"
          export GSETTINGS_SCHEMA_DIR="${HERE}/usr/share/glib-2.0/schemas"
          export GI_TYPELIB_PATH="${HERE}/usr/lib/girepository-1.0:${GI_TYPELIB_PATH}"

          export GDK_BACKEND=x11
          export GTK_THEME=Adwaita
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          export WEBKIT_FORCE_SANDBOX=0

          export HOME="${HOME:-/home/amnesia}"
          export TMPDIR="${TMPDIR:-/tmp}"

          cd "${HERE}/usr/bin"
          exec ./BIP39Recovery "$@"
          APPRUN
          chmod +x AppDir/AppRun

      - name: ÊûÑÂª∫ AppImageÔºà‰∏ç‰æùËµñ FUSEÔºâ
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract
          ARCH=x86_64 ./squashfs-root/AppRun AppDir BIP39Recovery-linux.AppImage
          chmod +x BIP39Recovery-linux.AppImage

      - name: È™åËØÅ WebKit Â≠êËøõÁ®ãÂ≠òÂú®
        run: |
          ./BIP39Recovery-linux.AppImage --appimage-extract
          test -x squashfs-root/usr/libexec/webkit2gtk-4.0/WebKitNetworkProcess
          test -x squashfs-root/usr/libexec/webkit2gtk-4.0/WebKitWebProcess
          test -x squashfs-root/usr/libexec/webkit2gtk-4.0/WebKitStorageProcess
          echo "‚úÖ WebKit Â≠êËøõÁ®ãÈΩêÂÖ®"

      - name: ÂàõÂª∫ Tails ‰ΩøÁî®ËØ¥Êòé
        run: |
          cat > TAILS-USAGE.md <<'EOF'
          # Âú® Tails OS ‰∏≠‰ΩøÁî® BIP39 Recovery Tool
          ## Âø´ÈÄüÂºÄÂßã
          ```bash
          chmod +x BIP39Recovery-linux.AppImage
          ./BIP39Recovery-linux.AppImage
          ```
          ‚úÖ Êó†ÈúÄÂÆâË£Ö‰æùËµñÔºåÂÆåÂÖ®Á¶ªÁ∫øËøêË°å  
          ‚ö†Ô∏è ‰ΩøÁî®ÂÆåËØ∑Á´ãÂç≥ÈáçÂêØ Tails ‰ª•Ê∏ÖÈô§ÂÜÖÂ≠ò„ÄÇ
          EOF

      - name: ÂàõÂª∫ tar.gz ‰∏é SHA256 Ê†°È™å
        run: |
          BINARY_PATH=$(find build/bin -type f -executable | head -n 1)
          cd build/bin
          tar -czf ../../BIP39Recovery-linux.tar.gz "$(basename "$BINARY_PATH")"
          cd ../..
          sha256sum BIP39Recovery-linux.AppImage BIP39Recovery-linux.tar.gz > SHA256SUMS.txt

      - name: ‰∏ä‰º† Linux ÊûÑÂª∫‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            BIP39Recovery-linux.AppImage
            BIP39Recovery-linux.tar.gz
            TAILS-USAGE.md
            SHA256SUMS.txt
          retention-days: 7

  # ==========================================================
  # Windows ÊûÑÂª∫‰ªªÂä°
  # ==========================================================
  build-windows:
    name: ÊûÑÂª∫ Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - run: choco install upx nsis -y
      - run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      - run: |
          cd frontend
          npm ci
          npm run build
      - run: wails build -clean -upx -nsis -o BIP39Recovery-windows.exe
      - run: |
          cd build/bin
          if (Test-Path "BIP39Recovery-windows-amd64-installer.exe") {
            Rename-Item "BIP39Recovery-windows-amd64-installer.exe" "BIP39Recovery-windows-installer.exe"
          }
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            build/bin/BIP39Recovery-windows.exe
            build/bin/BIP39Recovery-windows-installer.exe
          retention-days: 7

  # ==========================================================
  # macOS ÊûÑÂª∫‰ªªÂä°
  # ==========================================================
  build-macos:
    name: ÊûÑÂª∫ macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      - run: |
          cd frontend
          npm ci
          npm run build
      - run: |
          wails build -clean -o BIP39Recovery-macos
          cd build/bin
          zip -r ../../BIP39Recovery-macos.zip *
      - uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: BIP39Recovery-macos.zip
          retention-days: 7

  # ==========================================================
  # ÂàõÂª∫ Release
  # ==========================================================
  create-release:
    name: ÂàõÂª∫ÂèëÂ∏ÉÁâàÊú¨
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref_name == 'main' || github.ref_name == 'master'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Ëá™Âä®Â¢ûÂä†ÁâàÊú¨Âè∑
        id: version_bumper
        run: |
          if [ -f "frontend/package.json" ]; then
            current_version=$(node -p "require('./frontend/package.json').version")
          else
            current_version="1.0.0"
          fi
          major=$(echo $current_version | cut -d'.' -f1)
          minor=$(echo $current_version | cut -d'.' -f2)
          patch=$(echo $current_version | cut -d'.' -f3)
          new_patch=$((patch + 1))
          new_version="$major.$minor.$new_patch"
          echo "APP_VERSION=$new_version" >> $GITHUB_ENV
          echo "new_tag=v$new_version" >> $GITHUB_OUTPUT
          cd frontend
          npm version $new_version --no-git-tag-version
          cd ..

      - name: Êèê‰∫§ÁâàÊú¨Âè∑Êõ¥Êñ∞
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add frontend/package.json
          git commit -m "chore: Ëá™Âä®Â¢ûÂä†ÁâàÊú¨Ëá≥ ${{ env.APP_VERSION }} [skip ci]" || true
          git push || true

      - name: ‰∏ãËΩΩÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ÁîüÊàêÊõ¥Êñ∞Êó•Âøó + ÂìàÂ∏å
        run: |
          echo "## üöÄ BIP39 Recovery Tool v${{ env.APP_VERSION }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### üì¶ ‰∏ãËΩΩÊñá‰ª∂ÂèäÊ†°È™å" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          cat artifacts/linux-build/SHA256SUMS.txt >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### üîí ÂÆâÂÖ®ÊèêÁ§∫" >> CHANGELOG.md
          echo "- Âª∫ËÆÆ‰ªÖÂú®Á¶ªÁ∫øÔºàÊñ≠ÁΩëÔºâÁéØÂ¢É‰∏≠ÊÅ¢Â§çÂä©ËÆ∞ËØç" >> CHANGELOG.md
          echo "- ‰ΩøÁî®ÂÆåÊØïÂêéÈáçÂêØ Tails ‰ª•Ê∏ÖÈô§ÂÜÖÂ≠ò" >> CHANGELOG.md

      - name: ÂèëÂ∏ÉÂà∞ GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version_bumper.outputs.new_tag }}
          name: "BIP39 Recovery Tool v${{ env.APP_VERSION }}"
          body_path: CHANGELOG.md
          files: |
            artifacts/linux-build/BIP39Recovery-linux.AppImage
            artifacts/linux-build/BIP39Recovery-linux.tar.gz
            artifacts/linux-build/TAILS-USAGE.md
            artifacts/linux-build/SHA256SUMS.txt
            artifacts/windows-build/BIP39Recovery-windows.exe
            artifacts/windows-build/BIP39Recovery-windows-installer.exe
            artifacts/macos-build/BIP39Recovery-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
