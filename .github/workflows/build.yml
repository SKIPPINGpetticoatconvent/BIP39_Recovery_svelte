name: Build and Release (Windows + macOS + Linux/Tails)

permissions:
  contents: write

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ==========================================================
  # Linux ÊûÑÂª∫‰ªªÂä°ÔºàÈíàÂØπ Tails OS ‰ºòÂåñÔºâ
  # ==========================================================
  build-linux:
    name: ÊûÑÂª∫ Linux (Tails ÂÖºÂÆπ)
    runs-on: ubuntu-22.04
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ÁºìÂ≠ò Go Ê®°Âùó
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: ËÆæÁΩÆ Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ÂÆâË£ÖÁ≥ªÁªü‰æùËµñ
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            build-essential \
            pkg-config \
            file \
            desktop-file-utils

      - name: Ê∑ªÂä† GOPATH/bin Âà∞ PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ÂÆâË£Ö Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ÊûÑÂª∫ÂâçÁ´Ø
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor
        run: wails doctor
        continue-on-error: true

      - name: ÊûÑÂª∫ Linux Â∫îÁî®
        run: wails build -clean -platform linux/amd64

      - name: Ë∞ÉËØï - Êü•ÁúãÊûÑÂª∫‰∫ßÁâ©
        run: |
          echo "=== Ê£ÄÊü• build ÁõÆÂΩïÁªìÊûÑ ==="
          ls -R build/
          echo ""
          echo "=== Êü•ÊâæÂèØÊâßË°åÊñá‰ª∂ ==="
          find build -type f -executable -ls

      - name: ÂÆâË£Ö FUSE Âíå‰∏ãËΩΩ AppImage Â∑•ÂÖ∑
        run: |
          # ÂÆâË£Ö FUSE
          sudo apt-get install -y fuse libfuse2

          # ‰∏ãËΩΩÂπ∂ÊèêÂèñ appimagetool (ÈÅøÂÖç FUSE ÈóÆÈ¢ò)
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract

          # ‰∏ãËΩΩ linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage --appimage-extract
          mv squashfs-root linuxdeploy-root

          # ‰∏ãËΩΩ linuxdeploy-plugin-gtk
          wget https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-plugin-gtk.sh

      - name: ÂàõÂª∫ AppImageÔºàTails ÂÖºÂÆπÁâàÊú¨Ôºâ
        run: |
          # Êü•ÊâæÂÆûÈôÖÁöÑÂèØÊâßË°åÊñá‰ª∂
          BINARY_PATH=$(find build/bin -type f -executable | head -n 1)

          if [ -z "$BINARY_PATH" ]; then
            echo "ÈîôËØØ: Êâæ‰∏çÂà∞ÂèØÊâßË°åÊñá‰ª∂"
            echo "build/bin ÁõÆÂΩïÂÜÖÂÆπ:"
            ls -la build/bin/
            exit 1
          fi

          echo "ÊâæÂà∞ÂèØÊâßË°åÊñá‰ª∂: $BINARY_PATH"
          BINARY_NAME=$(basename "$BINARY_PATH")
          echo "ÂèØÊâßË°åÊñá‰ª∂Âêç: $BINARY_NAME"

          # ÂàõÂª∫Âü∫Á°ÄÁõÆÂΩï
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Â§çÂà∂ÂèØÊâßË°åÊñá‰ª∂
          cp "$BINARY_PATH" AppDir/usr/bin/BIP39Recovery
          chmod +x AppDir/usr/bin/BIP39Recovery

          # ÂàõÂª∫ .desktop Êñá‰ª∂ÔºàÁ¨¶Âêà Tails ÂÆâÂÖ®Ë¶ÅÊ±ÇÔºâ
          cat > AppDir/usr/share/applications/BIP39Recovery.desktop <<'EOF'
          [Desktop Entry]
          Name=BIP39 Recovery Tool
          Exec=BIP39Recovery
          Icon=BIP39Recovery
          Type=Application
          Categories=Utility;Finance;Security;
          Comment=BIP39 Mnemonic Recovery Tool (Tails Compatible)
          Terminal=false
          StartupNotify=true
          X-AppImage-Version=1.0
          EOF

          # È™åËØÅ desktop Êñá‰ª∂
          desktop-file-validate AppDir/usr/share/applications/BIP39Recovery.desktop || true

          # Â§çÂà∂ÂõæÊ†á
          if [ -f "build/appicon.png" ]; then
            cp build/appicon.png AppDir/usr/share/icons/hicolor/256x256/apps/BIP39Recovery.png
          else
            # ÂàõÂª∫ÁÆÄÂçïÂõæÊ†á‰Ωú‰∏∫ÂêéÂ§á
            echo "Ë≠¶Âëä: Êú™ÊâæÂà∞Â∫îÁî®ÂõæÊ†áÔºåÂàõÂª∫Âç†‰ΩçÂõæÊ†á"
            # ËøôÈáåÂèØ‰ª•Áî® ImageMagick ÂàõÂª∫ÁÆÄÂçïÂõæÊ†áÔºåÊàñËÄÖË∑≥Ëøá
          fi

          # ‰ΩøÁî® linuxdeploy ÊâìÂåÖÔºàËá™Âä®Â§ÑÁêÜ‰æùËµñÔºâ
          export DEPLOY_GTK_VERSION=3

          # ‰ΩøÁî®ÊèêÂèñÂêéÁöÑ linuxdeploy
          ./linuxdeploy-root/AppRun \
            --appdir AppDir \
            --plugin gtk \
            --executable AppDir/usr/bin/BIP39Recovery \
            --desktop-file AppDir/usr/share/applications/BIP39Recovery.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/BIP39Recovery.png \
            --output appimage || {
              echo "linuxdeploy Â§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî®‰º†ÁªüÊñπÊ≥ï..."
              
              # ‰º†Áªü AppImage ÊñπÊ≥ï‰Ωú‰∏∫ÂêéÂ§á
              # Â§çÂà∂ desktop ÂíåÂõæÊ†áÂà∞Ê†πÁõÆÂΩï
              cp AppDir/usr/share/applications/BIP39Recovery.desktop AppDir/
              if [ -f "AppDir/usr/share/icons/hicolor/256x256/apps/BIP39Recovery.png" ]; then
                cp AppDir/usr/share/icons/hicolor/256x256/apps/BIP39Recovery.png AppDir/
              fi
              
              # ÂàõÂª∫ AppRun
              cat > AppDir/AppRun <<'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"

          # Tails ÁâπÂÆöÁéØÂ¢ÉÂèòÈáè
          export TMPDIR="${TMPDIR:-/tmp}"
          export HOME="${HOME:-/home/amnesia}"

          # GTK Áõ∏ÂÖ≥ËÆæÁΩÆ
          export GTK_THEME="${GTK_THEME:-Adwaita}"
          export GDK_BACKEND=x11

          cd "${HERE}/usr/bin"
          exec ./BIP39Recovery "$@"
          APPRUN
              chmod +x AppDir/AppRun
              
              # ‰ΩøÁî® extract-and-run ÊñπÂºèËøêË°å appimagetool
              ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir BIP39Recovery-x86_64.AppImage || \
              ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir BIP39Recovery-x86_64.AppImage
            }

          # ÈáçÂëΩÂêçÊúÄÁªàÊñá‰ª∂
          if [ -f "BIP39_Recovery_Tool-x86_64.AppImage" ]; then
            mv BIP39_Recovery_Tool-x86_64.AppImage BIP39Recovery-linux.AppImage
          elif [ -f "BIP39Recovery-x86_64.AppImage" ]; then
            mv BIP39Recovery-x86_64.AppImage BIP39Recovery-linux.AppImage
          fi

          # ËÆæÁΩÆÊâßË°åÊùÉÈôê
          chmod +x BIP39Recovery-linux.AppImage

      - name: ÂàõÂª∫ Tails ‰ΩøÁî®ËØ¥Êòé
        run: |
          cat > TAILS-USAGE.md <<'EOF'
          # Âú® Tails OS ‰∏≠‰ΩøÁî® BIP39 Recovery Tool

          ## ‰∏ãËΩΩÂíåÂáÜÂ§á

          1. **‰∏ãËΩΩÊñá‰ª∂**
             - Âú® Tails ÁöÑ Tor Browser ‰∏≠‰∏ãËΩΩ `BIP39Recovery-linux.AppImage`
             - ‰øùÂ≠òÂà∞ÊåÅ‰πÖÂ≠òÂÇ®ÔºàPersistent StorageÔºâ‰ª•‰æøÈáçÂêØÂêéÁªßÁª≠‰ΩøÁî®

          2. **ËÆæÁΩÆÊùÉÈôê**
             ```bash
             chmod +x BIP39Recovery-linux.AppImage
             ```

          3. **ËøêË°åÂ∫îÁî®**
             ```bash
             ./BIP39Recovery-linux.AppImage
             ```
             ÊàñËÄÖÂèåÂáªÊñá‰ª∂ÂõæÊ†áËøêË°å

          ## ÂÆâÂÖ®Âª∫ËÆÆ

          ‚ö†Ô∏è **ÈáçË¶ÅÂÆâÂÖ®ÊèêÁ§∫**Ôºö

          - ‚úÖ ÂßãÁªàÂú®Êñ≠ÁΩëÁä∂ÊÄÅ‰∏ãËøêË°åÊïèÊÑüÊìç‰Ωú
          - ‚úÖ ‰ΩøÁî®ÂÆåÊØïÂêéÂÖ≥Èó≠Â∫îÁî®Âπ∂ÈáçÂêØ TailsÔºàÊ∏ÖÈô§ÂÜÖÂ≠òÔºâ
          - ‚úÖ ‰∏çË¶ÅÂ∞ÜÊÅ¢Â§çÁöÑÁßÅÈí•‰øùÂ≠òÂú®ÊåÅ‰πÖÂ≠òÂÇ®‰∏≠
          - ‚úÖ Â¶ÇÈúÄ‰øùÂ≠òÔºå‰ΩøÁî®Âä†ÂØÜÁöÑ USB ÊàñÁ¶ªÁ∫øÂ≠òÂÇ®
          - ‚úÖ Á°Æ‰øùÂú®ÂÆâÂÖ®ÁöÑÁâ©ÁêÜÁéØÂ¢É‰∏≠Êìç‰Ωú

          ## ÊïÖÈöúÊéíÈô§

          ### Â¶ÇÊûú AppImage Êó†Ê≥ïËøêË°åÔºö

          1. **Ê£ÄÊü• FUSE ÊîØÊåÅ**
             ```bash
             # Tails ÈÄöÂ∏∏Â∑≤ÂêØÁî® FUSE
             modprobe fuse
             ```

          2. **ÊèêÂèñÂπ∂ÊâãÂä®ËøêË°å**
             ```bash
             ./BIP39Recovery-linux.AppImage --appimage-extract
             cd squashfs-root
             ./AppRun
             ```

          3. **Êü•ÁúãÈîôËØØÊó•Âøó**
             ```bash
             ./BIP39Recovery-linux.AppImage 2>&1 | tee error.log
             ```

          ### Tails ÊåÅ‰πÖÂ≠òÂÇ®ËÆæÁΩÆ

          Â¶ÇÊûúÊÇ®ÊÉ≥Âú® Tails ÈáçÂêØÂêéÁªßÁª≠‰ΩøÁî®Ê≠§Â∑•ÂÖ∑Ôºö

          1. ÂêØÁî® Persistent Storage
          2. ÂàõÂª∫ "Personal Data" Êàñ "Additional Software" ÊåÅ‰πÖÂåñÊñá‰ª∂Â§π
          3. Â∞Ü AppImage ‰øùÂ≠òÂú®ÊåÅ‰πÖÂåñ‰ΩçÁΩÆ

          ## ÁΩëÁªúÈöîÁ¶ª

          Â¶ÇÊûúÈúÄË¶ÅÂÆåÂÖ®Êñ≠ÁΩëËøêË°åÔºö

          ```bash
          # Âú® Tails ‰∏≠Á¶ÅÁî®ÁΩëÁªúÔºàÈúÄË¶ÅÁÆ°ÁêÜÂëòÂØÜÁ†ÅÔºâ
          sudo systemctl stop NetworkManager

          # ËøêË°åÂ∫îÁî®
          ./BIP39Recovery-linux.AppImage

          # ÂÆåÊàêÂêéÈáçÂêØ Tails ‰ª•ÊÅ¢Â§çÁΩëÁªú
          ```

          ## ÂÖ≥‰∫é Tails ÁöÑÊ≥®ÊÑè‰∫ãÈ°π

          - Tails Âü∫‰∫é DebianÔºåAppImage ÂÆåÂÖ®ÂÖºÂÆπ
          - AppImage ‰∏çÈúÄË¶ÅÂÆâË£ÖÔºå‰∏ç‰øÆÊîπÁ≥ªÁªü
          - ÊâÄÊúâÊìç‰ΩúÂú®ÂÜÖÂ≠ò‰∏≠ËøõË°åÔºåÈáçÂêØÂêéËá™Âä®Ê∏ÖÈô§
          - ÈÄÇÂêàÂ§ÑÁêÜÊïèÊÑüÁöÑÂä†ÂØÜË¥ßÂ∏ÅÊÅ¢Â§ç‰ªªÂä°

          ---

          **ÈöêÁßÅÊèêÈÜí**: Êú¨Â∑•ÂÖ∑‰∏ì‰∏∫Á¶ªÁ∫ø‰ΩøÁî®ËÆæËÆ°„ÄÇÂú®Â§ÑÁêÜÂä©ËÆ∞ËØçÁ≠âÊïèÊÑü‰ø°ÊÅØÊó∂Ôºå
          ËØ∑Á°Æ‰øùÂ§Ñ‰∫éÂÆåÂÖ®Á¶ªÁ∫øÁä∂ÊÄÅÔºåÂπ∂Âú®‰ΩøÁî®ÂÆåÊàêÂêéÈáçÂêØ Tails ‰ª•Ê∏ÖÈô§ÊâÄÊúâÂÜÖÂ≠òÊï∞ÊçÆ„ÄÇ
          EOF

      - name: ÂêåÊó∂ÂàõÂª∫Ê†áÂáÜ tar.gz ÂåÖ
        run: |
          # Êü•ÊâæÂÆûÈôÖÁöÑÂèØÊâßË°åÊñá‰ª∂
          BINARY_PATH=$(find build/bin -type f -executable | head -n 1)
          BINARY_NAME=$(basename "$BINARY_PATH")

          cd build/bin
          tar -czf ../../BIP39Recovery-linux.tar.gz "$BINARY_NAME"
          cd ../..

          # ÂàõÂª∫ÁÆÄÂçïÁöÑ README
          cat > README-LINUX.txt <<'EOF'
          BIP39 Recovery Tool - Linux ÁâàÊú¨

          Êé®ËçêÊ†ºÂºèÔºöAppImageÔºàÈÄÇÁî®‰∫é Tails OSÔºâ
          Â§áÈÄâÊ†ºÂºèÔºötar.gzÔºàÈúÄË¶ÅÁ≥ªÁªü‰æùËµñÔºâ

          ‰ΩøÁî® AppImageÔºö
          1. chmod +x BIP39Recovery-linux.AppImage
          2. ./BIP39Recovery-linux.AppImage

          ‰ΩøÁî® tar.gzÔºö
          1. tar -xzf BIP39Recovery-linux.tar.gz
          2. sudo apt-get install libgtk-3-0 libwebkit2gtk-4.0-37
          3. chmod +x BIP39Recovery
          4. ./BIP39Recovery

          Tails Áî®Êà∑ËØ∑ÂèÇÈòÖ TAILS-USAGE.md
          EOF

      - name: È™åËØÅÊûÑÂª∫‰∫ßÁâ©
        run: |
          echo "=== ÊûÑÂª∫‰∫ßÁâ©ÂàóË°® ==="
          ls -lh BIP39Recovery-linux.AppImage BIP39Recovery-linux.tar.gz TAILS-USAGE.md README-LINUX.txt
          echo ""
          echo "=== AppImage Êñá‰ª∂‰ø°ÊÅØ ==="
          file BIP39Recovery-linux.AppImage
          echo ""
          echo "=== AppImage ÂèØÊâßË°åÊÄßÊµãËØï ==="
          chmod +x BIP39Recovery-linux.AppImage
          ./BIP39Recovery-linux.AppImage --appimage-help 2>&1 || echo "‚úì AppImage ÂàõÂª∫ÊàêÂäü"

      - name: ‰∏ä‰º† Linux ÊûÑÂª∫‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            BIP39Recovery-linux.AppImage
            BIP39Recovery-linux.tar.gz
            TAILS-USAGE.md
            README-LINUX.txt
          retention-days: 5

  # ==========================================================
  # Windows ÊûÑÂª∫‰ªªÂä°
  # ==========================================================
  build-windows:
    name: ÊûÑÂª∫ Windows
    runs-on: windows-latest
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ÁºìÂ≠ò Go Ê®°Âùó
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: ËÆæÁΩÆ Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ÂÆâË£Ö UPX Âíå NSIS
        run: choco install upx nsis -y

      - name: Ê∑ªÂä† GOPATH/bin Âà∞ PATH
        run: echo "$(go env GOPATH)/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      - name: ÂÆâË£Ö Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ÊûÑÂª∫ÂâçÁ´Ø
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (ÂèØÈÄâ)
        run: wails doctor
        continue-on-error: true

      - name: ÊûÑÂª∫ Windows Â∫îÁî®
        run: wails build -clean -upx -nsis -o BIP39Recovery-windows.exe

      - name: ÈáçÂëΩÂêçÊûÑÂª∫‰∫ßÁâ©
        shell: powershell
        run: |
          cd build/bin
          if (Test-Path "BIP39Recovery-windows-amd64-installer.exe") {
            Rename-Item "BIP39Recovery-windows-amd64-installer.exe" "BIP39Recovery-windows-installer.exe"
          }

      - name: ‰∏ä‰º† Windows ÂèØÊâßË°åÊñá‰ª∂
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: build/bin/BIP39Recovery-windows.exe
          retention-days: 5

      - name: ‰∏ä‰º† Windows ÂÆâË£ÖÁ®ãÂ∫è
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/bin/BIP39Recovery-windows-installer.exe
          retention-days: 5
        continue-on-error: true

  # ==========================================================
  # macOS ÊûÑÂª∫‰ªªÂä°
  # ==========================================================
  build-macos:
    name: ÊûÑÂª∫ macOS
    runs-on: macos-latest
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ÁºìÂ≠ò Go Ê®°Âùó
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: ËÆæÁΩÆ Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Ê∑ªÂä† GOPATH/bin Âà∞ PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ÂÆâË£Ö Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ÊûÑÂª∫ÂâçÁ´Ø
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (ÂèØÈÄâ)
        run: wails doctor
        continue-on-error: true

      - name: ÊûÑÂª∫ macOS Â∫îÁî®
        env:
          CGO_ENABLED: 1
        run: wails build -clean -o BIP39Recovery-macos

      - name: ÂàõÂª∫ macOS ÂéãÁº©ÂåÖ
        run: |
          cd build/bin
          if [ -d "BIP39Recovery-macos.app" ]; then
            zip -r ../../BIP39Recovery-macos.zip BIP39Recovery-macos.app
          else
            zip -r ../../BIP39Recovery-macos.zip *
          fi

      - name: ‰∏ä‰º† macOS ÊûÑÂª∫‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: BIP39Recovery-macos.zip
          retention-days: 5

  # ==========================================================
  # ÂàõÂª∫ Release
  # ==========================================================
  create-release:
    name: ÂàõÂª∫ÂèëÂ∏ÉÁâàÊú¨
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    concurrency:
      group: "release-${{ github.ref }}"
      cancel-in-progress: true
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Ëá™Âä®Â¢ûÂä†ÁâàÊú¨Âè∑
        id: version_bumper
        run: |
          if [ -f "frontend/package.json" ]; then
            current_version=$(node -p "require('./frontend/package.json').version" 2>/dev/null || echo "1.0.0")
          else
            current_version="1.0.0"
          fi
          major=$(echo $current_version | cut -d'.' -f1)
          minor=$(echo $current_version | cut -d'.' -f2)
          patch=$(echo $current_version | cut -d'.' -f3)
          new_patch=$((patch + 1))
          new_version="$major.$minor.$new_patch"
          echo "ÊóßÁâàÊú¨: $current_version"
          echo "Êñ∞ÁâàÊú¨: $new_version"
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm version $new_version --no-git-tag-version --allow-same-version
            cd ..
          fi
          echo "APP_VERSION=$new_version" >> $GITHUB_ENV
          echo "new_tag=v$new_version" >> $GITHUB_OUTPUT

      - name: Êèê‰∫§Âπ∂Êé®ÈÄÅÁâàÊú¨Êõ¥Êñ∞
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add frontend/package.json
          if git diff --staged --quiet; then
            echo "ÁâàÊú¨Âè∑Êú™Êõ¥ÊîπÔºåÊó†ÈúÄÊèê‰∫§„ÄÇ"
          else
            git commit -m "chore: Ëá™Âä®Â¢ûÂä†ÁâàÊú¨Ëá≥ ${{ env.APP_VERSION }} [skip ci]"
            git push
          fi

      - name: ‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Ê£ÄÊü• Release ÊòØÂê¶Â∑≤Â≠òÂú®
        id: check_release
        run: |
          if gh release view "${{ steps.version_bumper.outputs.new_tag }}" >/dev/null 2>&1; then
            echo "skip_release=true" >> $GITHUB_OUTPUT
          else
            echo "skip_release=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ release Ê†áÁ≠æ
        id: get_previous_tag
        if: steps.check_release.outputs.skip_release == 'false'
        run: |
          PREVIOUS_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ÁîüÊàêÊõ¥Êñ∞Êó•Âøó
        id: generate_changelog
        if: steps.check_release.outputs.skip_release == 'false'
        run: |
          echo "## üöÄ BIP39 Recovery Tool - Êõ¥Êñ∞ÂÜÖÂÆπ" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ‚ú® Êñ∞ÂäüËÉΩ" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="feat\|add\|new" | sed 's/^/- /' >> CHANGELOG.md || echo "- Êó†Êñ∞ÂäüËÉΩÊõ¥Êñ∞" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### üêõ ÈîôËØØ‰øÆÂ§ç" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="fix\|bug" | sed 's/^/- /' >> CHANGELOG.md || echo "- Êó†ÈîôËØØ‰øÆÂ§ç" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ‚öôÔ∏è ÂÖ∂‰ªñÊîπËøõ" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="chore\|refactor\|perf\|optimize" | sed 's/^/- /' >> CHANGELOG.md || echo "- Êó†ÂÖ∂‰ªñÊîπËøõ" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### üì¶ ‰∏ãËΩΩËØ¥Êòé" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "#### Windows" >> CHANGELOG.md
          echo "- ‰∏ãËΩΩ \`BIP39Recovery-windows.exe\` Áõ¥Êé•ËøêË°å" >> CHANGELOG.md
          echo "- Êàñ‰ΩøÁî® \`BIP39Recovery-windows-installer.exe\` ÂÆâË£ÖÁâàÊú¨" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "#### macOS" >> CHANGELOG.md
          echo "- ‰∏ãËΩΩ \`BIP39Recovery-macos.zip\`ÔºåËß£ÂéãÂêéËøêË°å" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "#### Linux (Tails OS ÂÖºÂÆπ) üîí" >> CHANGELOG.md
          echo "- **Êé®Ëçê**: \`BIP39Recovery-linux.AppImage\` (Êó†ÈúÄÂÆâË£Ö‰æùËµñ)" >> CHANGELOG.md
          echo "  1. \`chmod +x BIP39Recovery-linux.AppImage\`" >> CHANGELOG.md
          echo "  2. \`./BIP39Recovery-linux.AppImage\`" >> CHANGELOG.md
          echo "- **Â§áÈÄâ**: \`BIP39Recovery-linux.tar.gz\` (ÈúÄË¶ÅÁ≥ªÁªü‰æùËµñ)" >> CHANGELOG.md
          echo "- **Tails Áî®Êà∑**: ËØ∑ÈòÖËØª \`TAILS-USAGE.md\` Ëé∑ÂèñËØ¶ÁªÜÊåáÂçó" >> CHANGELOG.md
          echo "- **ÂÆâÂÖ®ÊèêÁ§∫**: Â§ÑÁêÜÂä©ËÆ∞ËØçÊó∂Âª∫ËÆÆÊñ≠ÁΩëÊìç‰ΩúÔºå‰ΩøÁî®ÂÆåÊØïÈáçÂêØ Tails" >> CHANGELOG.md

      - name: ÂàõÂª∫Âπ∂‰∏ä‰º†ÂèëË°åÁâà
        if: steps.check_release.outputs.skip_release == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version_bumper.outputs.new_tag }}
          name: BIP39 Recovery Tool ${{ env.APP_VERSION }}
          body_path: CHANGELOG.md
          files: |
            artifacts/linux-build/BIP39Recovery-linux.AppImage
            artifacts/linux-build/BIP39Recovery-linux.tar.gz
            artifacts/linux-build/TAILS-USAGE.md
            artifacts/linux-build/README-LINUX.txt
            artifacts/windows-exe/BIP39Recovery-windows.exe
            artifacts/windows-installer/BIP39Recovery-windows-installer.exe
            artifacts/macos-build/BIP39Recovery-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
