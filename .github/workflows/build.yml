name: Build and Release (Windows + macOS + Linux)

permissions:
  contents: write

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ==========================================================
  # Linux ÊûÑÂª∫‰ªªÂä°
  # ==========================================================
  build-linux:
    name: ÊûÑÂª∫ Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ‚úÖ ÁºìÂ≠ò Go Ê®°Âùó
      - name: ÁºìÂ≠ò Go Ê®°Âùó
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: ËÆæÁΩÆ Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      # ‚úÖ Node.js ÂßãÁªà‰ΩøÁî®ÊúÄÊñ∞ LTS ÁâàÊú¨
      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ÂÆâË£ÖÁ≥ªÁªü‰æùËµñ
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            build-essential \
            pkg-config

      - name: Ê∑ªÂä† GOPATH/bin Âà∞ PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ÂÆâË£Ö Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ÊûÑÂª∫ÂâçÁ´Ø
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (ÂèØÈÄâ)
        run: wails doctor
        continue-on-error: true

      - name: ÊûÑÂª∫ Linux Â∫îÁî®
        run: wails build -clean -o BIP39Recovery-linux

      - name: ÂàõÂª∫ Linux ÂéãÁº©ÂåÖ
        run: |
          cd build/bin
          tar -czf ../../BIP39Recovery-linux.tar.gz *

      - name: ‰∏ä‰º† Linux ÊûÑÂª∫‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: BIP39Recovery-linux.tar.gz
          retention-days: 5

  # ==========================================================
  # Windows ÊûÑÂª∫‰ªªÂä°
  # ==========================================================
  build-windows:
    name: ÊûÑÂª∫ Windows
    runs-on: windows-latest
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ‚úÖ ÁºìÂ≠ò Go Ê®°Âùó
      - name: ÁºìÂ≠ò Go Ê®°Âùó
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: ËÆæÁΩÆ Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      # ‚úÖ Node.js ‰ΩøÁî® LTS
      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ÂÆâË£Ö UPX Âíå NSIS
        run: choco install upx nsis -y

      - name: Ê∑ªÂä† GOPATH/bin Âà∞ PATH
        run: echo "$(go env GOPATH)/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      - name: ÂÆâË£Ö Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ÊûÑÂª∫ÂâçÁ´Ø
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (ÂèØÈÄâ)
        run: wails doctor
        continue-on-error: true

      - name: ÊûÑÂª∫ Windows Â∫îÁî®
        run: wails build -clean -upx -nsis -o BIP39Recovery-windows.exe

      - name: ÈáçÂëΩÂêçÊûÑÂª∫‰∫ßÁâ©
        shell: powershell
        run: |
          cd build/bin
          if (Test-Path "BIP39Recovery-windows-amd64-installer.exe") {
            Rename-Item "BIP39Recovery-windows-amd64-installer.exe" "BIP39Recovery-windows-installer.exe"
          }

      - name: ‰∏ä‰º† Windows ÂèØÊâßË°åÊñá‰ª∂
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: build/bin/BIP39Recovery-windows.exe
          retention-days: 5

      - name: ‰∏ä‰º† Windows ÂÆâË£ÖÁ®ãÂ∫è
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/bin/BIP39Recovery-windows-installer.exe
          retention-days: 5
        continue-on-error: true

  # ==========================================================
  # macOS ÊûÑÂª∫‰ªªÂä°
  # ==========================================================
  build-macos:
    name: ÊûÑÂª∫ macOS
    runs-on: macos-latest
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ‚úÖ ÁºìÂ≠ò Go Ê®°Âùó
      - name: ÁºìÂ≠ò Go Ê®°Âùó
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: ËÆæÁΩÆ Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      # ‚úÖ Node.js ‰ΩøÁî® LTS
      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Ê∑ªÂä† GOPATH/bin Âà∞ PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: ÂÆâË£Ö Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ÊûÑÂª∫ÂâçÁ´Ø
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (ÂèØÈÄâ)
        run: wails doctor
        continue-on-error: true

      - name: ÊûÑÂª∫ macOS Â∫îÁî®
        env:
          CGO_ENABLED: 1
        run: wails build -clean -o BIP39Recovery-macos

      - name: ÂàõÂª∫ macOS ÂéãÁº©ÂåÖ
        run: |
          cd build/bin
          if [ -d "BIP39Recovery-macos.app" ]; then
            zip -r ../../BIP39Recovery-macos.zip BIP39Recovery-macos.app
          else
            zip -r ../../BIP39Recovery-macos.zip *
          fi

      - name: ‰∏ä‰º† macOS ÊûÑÂª∫‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: BIP39Recovery-macos.zip
          retention-days: 5

  # ==========================================================
  # ÂàõÂª∫ Release
  # ==========================================================
  create-release:
    name: ÂàõÂª∫ÂèëÂ∏ÉÁâàÊú¨
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    concurrency:
      group: "release-${{ github.ref }}"
      cancel-in-progress: true
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Ëá™Âä®Â¢ûÂä†ÁâàÊú¨Âè∑
        id: version_bumper
        run: |
          if [ -f "frontend/package.json" ]; then
            current_version=$(node -p "require('./frontend/package.json').version" 2>/dev/null || echo "1.0.0")
          else
            current_version="1.0.0"
          fi
          major=$(echo $current_version | cut -d'.' -f1)
          minor=$(echo $current_version | cut -d'.' -f2)
          patch=$(echo $current_version | cut -d'.' -f3)
          new_patch=$((patch + 1))
          new_version="$major.$minor.$new_patch"
          echo "ÊóßÁâàÊú¨: $current_version"
          echo "Êñ∞ÁâàÊú¨: $new_version"
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm version $new_version --no-git-tag-version --allow-same-version
            cd ..
          fi
          echo "APP_VERSION=$new_version" >> $GITHUB_ENV
          echo "new_tag=v$new_version" >> $GITHUB_OUTPUT

      - name: Êèê‰∫§Âπ∂Êé®ÈÄÅÁâàÊú¨Êõ¥Êñ∞
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add frontend/package.json
          if git diff --staged --quiet; then
            echo "ÁâàÊú¨Âè∑Êú™Êõ¥ÊîπÔºåÊó†ÈúÄÊèê‰∫§„ÄÇ"
          else
            git commit -m "chore: Ëá™Âä®Â¢ûÂä†ÁâàÊú¨Ëá≥ ${{ env.APP_VERSION }} [skip ci]"
            git push
          fi

      - name: ‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Ê£ÄÊü• Release ÊòØÂê¶Â∑≤Â≠òÂú®
        id: check_release
        run: |
          if gh release view "${{ steps.version_bumper.outputs.new_tag }}" >/dev/null 2>&1; then
            echo "skip_release=true" >> $GITHUB_OUTPUT
          else
            echo "skip_release=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ release Ê†áÁ≠æ
        id: get_previous_tag
        if: steps.check_release.outputs.skip_release == 'false'
        run: |
          PREVIOUS_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ÁîüÊàêÊõ¥Êñ∞Êó•Âøó
        id: generate_changelog
        if: steps.check_release.outputs.skip_release == 'false'
        run: |
          echo "## üöÄ BIP39 Recovery Tool - Êõ¥Êñ∞ÂÜÖÂÆπ" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ‚ú® Êñ∞ÂäüËÉΩ" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="feat\|add\|new" | sed 's/^/- /' >> CHANGELOG.md || echo "- Êó†Êñ∞ÂäüËÉΩÊõ¥Êñ∞" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### üêõ ÈîôËØØ‰øÆÂ§ç" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="fix\|bug" | sed 's/^/- /' >> CHANGELOG.md || echo "- Êó†ÈîôËØØ‰øÆÂ§ç" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ‚öôÔ∏è ÂÖ∂‰ªñÊîπËøõ" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="chore\|refactor\|perf\|optimize" | sed 's/^/- /' >> CHANGELOG.md || echo "- Êó†ÂÖ∂‰ªñÊîπËøõ" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### üì¶ ‰∏ãËΩΩËØ¥Êòé" >> CHANGELOG.md
          echo "- **Windows**: \`BIP39Recovery-windows-installer.exe\` Êàñ \`BIP39Recovery-windows.exe\`" >> CHANGELOG.md
          echo "- **macOS**: \`BIP39Recovery-macos.zip\`" >> CHANGELOG.md
          echo "- **Linux**: \`BIP39Recovery-linux.tar.gz\`" >> CHANGELOG.md

      - name: ÂàõÂª∫Âπ∂‰∏ä‰º†ÂèëË°åÁâà
        if: steps.check_release.outputs.skip_release == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version_bumper.outputs.new_tag }}
          name: BIP39 Recovery Tool ${{ env.APP_VERSION }}
          body_path: CHANGELOG.md
          files: |
            artifacts/linux-build/BIP39Recovery-linux.tar.gz
            artifacts/windows-exe/BIP39Recovery-windows.exe
            artifacts/windows-installer/BIP39Recovery-windows-installer.exe
            artifacts/macos-build/BIP39Recovery-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
