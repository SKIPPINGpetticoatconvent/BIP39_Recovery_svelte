name: Build and Release (Windows + macOS + Linux)

# ==========================================================
# æƒé™å£°æ˜
# ==========================================================
permissions:
  contents: write # æˆäºˆ GITHUB_TOKEN å¯¹ä»“åº“å†…å®¹çš„å†™æƒé™ï¼Œä»¥ä¾¿æ¨é€ç‰ˆæœ¬æ›´æ–°å’Œåˆ›å»º Release

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  # ==========================================================
  # Linux æ„å»ºä»»åŠ¡
  # ==========================================================
  build-linux:
    name: æ„å»º Linux
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            build-essential \
            pkg-config

      - name: æ·»åŠ  GOPATH/bin åˆ° PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: å®‰è£… Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: æ„å»ºå‰ç«¯
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (å¯é€‰)
        run: wails doctor
        continue-on-error: true

      - name: æ„å»º Linux åº”ç”¨
        run: wails build -clean -o BIP39Recovery-linux

      - name: åˆ›å»º Linux å‹ç¼©åŒ…
        run: |
          cd build/bin
          tar -czf ../../BIP39Recovery-linux.tar.gz *

      - name: ä¸Šä¼  Linux æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: BIP39Recovery-linux.tar.gz
          retention-days: 5

  # ==========================================================
  # Windows æ„å»ºä»»åŠ¡
  # ==========================================================
  build-windows:
    name: æ„å»º Windows
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: å®‰è£… UPX å’Œ NSIS
        run: choco install upx nsis -y

      - name: æ·»åŠ  GOPATH/bin åˆ° PATH
        run: echo "$(go env GOPATH)/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      - name: å®‰è£… Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: æ„å»ºå‰ç«¯
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (å¯é€‰)
        run: wails doctor
        continue-on-error: true

      - name: æ„å»º Windows åº”ç”¨
        run: wails build -clean -upx -nsis -o BIP39Recovery-windows.exe

      - name: é‡å‘½åæ„å»ºäº§ç‰©
        shell: powershell
        run: |
          cd build/bin
          if (Test-Path "BIP39Recovery-windows-amd64-installer.exe") {
            Rename-Item "BIP39Recovery-windows-amd64-installer.exe" "BIP39Recovery-windows-installer.exe"
          }

      - name: ä¸Šä¼  Windows å¯æ‰§è¡Œæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: build/bin/BIP39Recovery-windows.exe
          retention-days: 5

      - name: ä¸Šä¼  Windows å®‰è£…ç¨‹åº
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/bin/BIP39Recovery-windows-installer.exe
          retention-days: 5
        continue-on-error: true

  # ==========================================================
  # macOS æ„å»ºä»»åŠ¡
  # ==========================================================
  build-macos:
    name: æ„å»º macOS
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: æ·»åŠ  GOPATH/bin åˆ° PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: å®‰è£… Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: æ„å»ºå‰ç«¯
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Wails Doctor (å¯é€‰)
        run: wails doctor
        continue-on-error: true

      - name: æ„å»º macOS åº”ç”¨
        run: wails build -clean -o BIP39Recovery-macos

      - name: åˆ›å»º macOS å‹ç¼©åŒ…
        run: |
          cd build/bin
          if [ -d "BIP39Recovery-macos.app" ]; then
            zip -r ../../BIP39Recovery-macos.zip BIP39Recovery-macos.app
          else
            zip -r ../../BIP39Recovery-macos.zip *
          fi

      - name: ä¸Šä¼  macOS æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: BIP39Recovery-macos.zip
          retention-days: 5

  # ==========================================================
  # åˆ›å»º Release
  # ==========================================================
  create-release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: è‡ªåŠ¨å¢åŠ ç‰ˆæœ¬å·
        id: version_bumper
        run: |
          # ä» frontend/package.json è¯»å–å½“å‰ç‰ˆæœ¬
          if [ -f "frontend/package.json" ]; then
            current_version=$(node -p "require('./frontend/package.json').version" 2>/dev/null || echo "1.0.0")
          else
            current_version="1.0.0"
          fi

          # è§£æç‰ˆæœ¬å·
          major=$(echo $current_version | cut -d'.' -f1)
          minor=$(echo $current_version | cut -d'.' -f2)
          patch=$(echo $current_version | cut -d'.' -f3)
          new_patch=$((patch + 1))

          new_version="$major.$minor.$new_patch"
          echo "æ—§ç‰ˆæœ¬: $current_version"
          echo "æ–°ç‰ˆæœ¬: $new_version"

          # æ›´æ–° frontend/package.json ç‰ˆæœ¬å·
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm version $new_version --no-git-tag-version --allow-same-version
            cd ..
          fi

          echo "APP_VERSION=$new_version" >> $GITHUB_ENV
          echo "new_tag=v$new_version" >> $GITHUB_OUTPUT

      - name: æäº¤å¹¶æ¨é€ç‰ˆæœ¬æ›´æ–°
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add frontend/package.json
          if git diff --staged --quiet; then
            echo "ç‰ˆæœ¬å·æœªæ›´æ”¹ï¼Œæ— éœ€æäº¤ã€‚"
          else
            git commit -m "chore: è‡ªåŠ¨å¢åŠ ç‰ˆæœ¬è‡³ ${{ env.APP_VERSION }} [skip ci]"
            git push
            echo "å·²æˆåŠŸæ¨é€ç‰ˆæœ¬æ›´æ–°ã€‚"
          fi

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶ (è°ƒè¯•ç”¨)
        run: find artifacts -type f -ls

      - name: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ release
        id: check_release
        run: |
          if gh release view "${{ steps.version_bumper.outputs.new_tag }}" >/dev/null 2>&1; then
            echo "Release ${{ steps.version_bumper.outputs.new_tag }} å·²å­˜åœ¨ï¼Œè·³è¿‡..."
            echo "skip_release=true" >> $GITHUB_OUTPUT
          else
            echo "Release ${{ steps.version_bumper.outputs.new_tag }} ä¸å­˜åœ¨ï¼Œç»§ç»­..."
            echo "skip_release=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–ä¸Šä¸€ä¸ª release æ ‡ç­¾
        id: get_previous_tag
        if: steps.check_release.outputs.skip_release == 'false'
        run: |
          PREVIOUS_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
          echo "ä¸Šä¸€ä¸ªæ ‡ç­¾: $PREVIOUS_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: generate_changelog
        if: steps.check_release.outputs.skip_release == 'false'
        run: |
          echo "## ğŸš€ BIP39 Recovery Tool - æ›´æ–°å†…å®¹" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          echo "### âœ¨ æ–°åŠŸèƒ½" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="feat\|add\|new" --grep="åŠŸèƒ½\|æ–°å¢" | sed 's/^/- /' >> CHANGELOG.md || echo "- æ— æ–°åŠŸèƒ½æ›´æ–°" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          echo "### ğŸ› é”™è¯¯ä¿®å¤" >> CHANGELOG.md
          git log ${{ env.PREVIOUS_TAG }}..HEAD --oneline --grep="fix\|bug" --grep="ä¿®å¤\|ä¿®æ­£" | sed 's/^/- /' >> CHANGELOG.md || echo "- æ— é”™è¯¯ä¿®å¤" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          echo "### ğŸ“¦ ä¸‹è½½è¯´æ˜" >> CHANGELOG.md
          echo "- **Windows**: ä¸‹è½½ \`BIP39Recovery-windows-installer.exe\` (å®‰è£…ç¨‹åº) æˆ– \`BIP39Recovery-windows.exe\` (ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶)" >> CHANGELOG.md
          echo "- **macOS**: ä¸‹è½½ \`BIP39Recovery-macos.zip\`ï¼Œè§£å‹åè¿è¡Œ" >> CHANGELOG.md
          echo "- **Linux**: ä¸‹è½½ \`BIP39Recovery-linux.tar.gz\`ï¼Œè§£å‹åè¿è¡Œ" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          echo "---" >> CHANGELOG.md
          echo "**æ„å»ºä¿¡æ¯:**" >> CHANGELOG.md
          echo "- æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> CHANGELOG.md
          echo "- Commit: $(git rev-parse --short HEAD)" >> CHANGELOG.md
          echo "- Wails ç‰ˆæœ¬: v2.10.2" >> CHANGELOG.md

          cat CHANGELOG.md

      - name: åˆ›å»ºå¹¶ä¸Šä¼ å‘è¡Œç‰ˆ
        if: steps.check_release.outputs.skip_release == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version_bumper.outputs.new_tag }}
          name: BIP39 Recovery Tool ${{ env.APP_VERSION }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            artifacts/linux-build/BIP39Recovery-linux.tar.gz
            artifacts/windows-exe/BIP39Recovery-windows.exe
            artifacts/windows-installer/BIP39Recovery-windows-installer.exe
            artifacts/macos-build/BIP39Recovery-macos.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: steps.check_release.outputs.skip_release == 'false'
        run: |
          echo "ğŸ‰ Release ${{ env.APP_VERSION }} åˆ›å»ºæˆåŠŸ!"
          echo "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version_bumper.outputs.new_tag }}"
          echo ""
          echo "ğŸ“¦ å‘å¸ƒå†…å®¹:"
          echo "  âœ… Linux:   BIP39Recovery-linux.tar.gz"
          echo "  âœ… Windows: BIP39Recovery-windows.exe + å®‰è£…ç¨‹åº"
          echo "  âœ… macOS:   BIP39Recovery-macos.zip"
